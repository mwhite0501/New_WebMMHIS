@page "/{routeId?}/{sectionId?}/{directionId?}/{searchText?}/{yearId?}"
@using Radzen
@using Radzen.Blazor;
@using System.Collections;
@using System.Timers;
@using System.IO;
@using System;
@using Newtonsoft.Json;
@using ImageResizer; 
@using System.Drawing;
@using System.Net.NetworkInformation;
@using System.Net;
@using System.Drawing.Imaging
@using Microsoft.Extensions.Configuration;
@using System.Text.Json;

@inject IJSRuntime JSRuntime
@inject MmhisController controller
@inject PageModel pageModel
@inject NavigationManager NavigationManager


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<button class="openbtn" onclick="openNav()">&#9776; Search</button>

<div id="main" style="margin-left: 250px">
    @if(IsLandscapeMode == false) 
    {

        <div class="video-container" id="video-container">
            @if (spinning == true)
            {
                <div class="spinner"></div>
            }
            @if(Images.Any())
            {
                if (notes != null && !string.IsNullOrWhiteSpace(notes.FirstOrDefault()))
                {
                    <b style="color:red; position: absolute; top: 0; left: 0; background-color: transparent; padding: 5px;">NOTE: @notes.FirstOrDefault().ToUpper()</b>
                }
            }
            
            <div class="video-controls-container">
                
                <div class="controls">
                    @if (Images.Any()) //check if there are any images loaded in the list, then display these buttons
                    {
                        if (isMobile == true) //check if a mobile device is not detected. JSInterop was used
                        {
                            <menu class="medium">
                                <button class="rw" @ontouchstart="() => { idx = idx - 1 < 0 ? Logmeters.Count() - 1 : idx - 1; isPause = true; }"></button>
                                <button class="play" style="transform: rotate(180deg); transform: rotateY(180deg);" @ontouchstart="() => { isPause = !isPause; OnSubmitReverse(); isTouchScreen = true; }"></button>
                                <button class="pause" @ontouchstart="() => {for(int i = 0; i<4;i++){isPause=true;}}"></button>
                                <button class="play" @ontouchstart="() => { isPause = !isPause; OnSubmitPlay(); isTouchScreen = true; }"></button>
                                <button class="ff" @ontouchstart="() => { idx = idx + 1 >= Logmeters.Count() ? 0 : idx + 1; isPause = true; }"></button>
                                <button @onclick="ToggleFullScreen" style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; border: 0px none; margin: 10px; padding: 0px; text-transform: none; appearance: none; position: absolute; cursor: pointer; user-select: none; border-radius: 2px; height: 40px; width: 40px; box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px; overflow: hidden; top: 0px; right: 0px;" draggable="false" aria-label="Toggle fullscreen view" title="Toggle fullscreen view" type="button" aria-pressed="false" class="gm-control-active gm-fullscreen-control">
                                    <img style="height: 18px; width: 18px;" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2018%2018%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M0%200v6h2V2h4V0H0zm16%200h-4v2h4v4h2V0h-2zm0%2016h-4v2h6v-6h-2v4zM2%2012H0v6h6v-2H2v-4z%22/%3E%3C/svg%3E" alt="">
                                </button>

                            </menu>
                        }
                        else if (isMobile == false)
                        {
                            <menu class="small">
                                <button class="rw" @onmousedown="() => { idx = idx - 1 < 0 ? Logmeters.Count() - 1: idx - 1; isPause = true; }"></button>
                                <button class="play" style="transform: rotate(180deg); transform: rotateY(180deg);" @onmousedown="() => { isPause = !isPause; OnSubmitReverse(); isTouchScreen = true; }"></button>
                                <button class="pause" @onmousedown="() => {for(int i = 0; i<4;i++){isPause=true;}}"></button>
                                <button class="play" @onmousedown="() => { isPause = !isPause; OnSubmitPlay(); isTouchScreen = true; }"></button>
                                <button class="ff" @onmousedown="() => { idx = idx + 1 >= Logmeters.Count() ? 0 : idx + 1; isPause = true; }"></button>
                                <button @onclick="ToggleFullScreen" style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; border: 0px none; margin: 10px; padding: 0px; text-transform: none; appearance: none; position: absolute; cursor: pointer; user-select: none; border-radius: 2px; height: 40px; width: 40px; box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px; overflow: hidden; top: 0px; right: 0px;" draggable="false" aria-label="Toggle fullscreen view" title="Toggle fullscreen view" type="button" aria-pressed="false" class="gm-control-active gm-fullscreen-control">
                                    <img style="height: 18px; width: 18px;" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2018%2018%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M0%200v6h2V2h4V0H0zm16%200h-4v2h4v4h2V0h-2zm0%2016h-4v2h6v-6h-2v4zM2%2012H0v6h6v-2H2v-4z%22/%3E%3C/svg%3E" alt="">
                                </button>
                            </menu>
                        }

                    }
                    

                </div>
                <div class="timeline-continer">
                    @if (Images.Any())
                    {
                        int maxslide = Logmeters.Count() - 1;
                        <RadzenSlider class="playprogress" @bind-Value="@idx" Style="width:100%;height:10px" Max="@maxslide"></RadzenSlider>
                    }
                </div>

            </div>
            


            @if (Images.Any())
            {
                

                //zoom=15;
                int maxslide = Logmeters.Count() - 1;
                //if(!File.Exists(unmodifiedURLs[idx])){idx++;}
                //if(!File.Exists("\\\\mmhisdata-01\\" + unmodifiedURLs[idx].Substring(7))) { idx++; } //need to throw a missing frame img
                switch(imgType)
                {
                case 1:
                    byte[] byteArrayRight;

                    if (File.Exists(unmodifiedURLsRight[idx]))
                    {
                        byteArrayRight = ConvertImageToByteArray(unmodifiedURLsRight[idx]);
                    }
                    else
                    {
                        var adjustedPathRight = RemoveRootFromPath(unmodifiedURLsRight[idx]);
                        var fullPathRight = GetImagePath(adjustedPathRight);
                        byteArrayRight = ConvertImageToByteArray(fullPathRight);
                    }
                    if(isHighRes == false)
                    {
                        var resizedArrayRight = ResizeImage(byteArrayRight);
                        string imgStringRight = Convert.ToBase64String(resizedArrayRight);
                        <img src="data:image/jpg;base64, @imgStringRight" style="width: 100%; height: auto;"  onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    else
                    {
                        string imgStringRight = Convert.ToBase64String(byteArrayRight);
                        <img src="data:image/jpg;base64, @imgStringRight" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    break;
                case 2:
                    byte[] byteArrayLeft;

                    if (File.Exists(unmodifiedURLsLeft[idx]))
                    {
                        byteArrayLeft = ConvertImageToByteArray(unmodifiedURLsLeft[idx]);
                    }
                    else
                    {
                        var adjustedPathLeft = RemoveRootFromPath(unmodifiedURLsLeft[idx]);
                        var fullPathLeft = GetImagePath(adjustedPathLeft);
                        byteArrayLeft = ConvertImageToByteArray(fullPathLeft);
                    }
                  //fix index out of range on older routes
                    if(isHighRes == false)
                    {
                        var resizedArrayLeft = ResizeImage(byteArrayLeft); 
                        string imgStringLeft = Convert.ToBase64String(resizedArrayLeft);
                        <img src="data:image/jpg;base64, @imgStringLeft" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    else
                    {
                        string imgStringLeft = Convert.ToBase64String(byteArrayLeft);
                        <img src="data:image/jpg;base64, @imgStringLeft" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    break;
                case 3:
                    byte[] byteArrayRRight;

                    if (File.Exists(unmodifiedURLsRRight[idx]))
                    {
                        byteArrayRRight = ConvertImageToByteArray(unmodifiedURLsRRight[idx]);
                    }
                    else
                    {
                        var adjustedPathRRight = RemoveRootFromPath(unmodifiedURLsRRight[idx]);
                        var fullPathRRight = GetImagePath(adjustedPathRRight);
                        byteArrayRRight = ConvertImageToByteArray(fullPathRRight);
                    }
                    if(isHighRes == false)
                    {
                        var resizedArrayRRight = ResizeImage(byteArrayRRight);
                        string imgStringRRight = Convert.ToBase64String(resizedArrayRRight);
                        <img src="data:image/jpg;base64, @imgStringRRight" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    else
                    {
                        string imgStringRRight = Convert.ToBase64String(byteArrayRRight);
                        <img src="data:image/jpg;base64, @imgStringRRight" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    break;
                case 4:
                    byte[] byteArrayRLeft;

                    if (File.Exists(unmodifiedURLsRLeft[idx]))
                    {
                        byteArrayRLeft = ConvertImageToByteArray(unmodifiedURLsRLeft[idx]);
                    }
                    else
                    {
                        var adjustedPathRLeft = RemoveRootFromPath(unmodifiedURLsRLeft[idx]);
                        var fullPathRLeft = GetImagePath(adjustedPathRLeft);
                        byteArrayRLeft = ConvertImageToByteArray(fullPathRLeft);
                    }
                    if(isHighRes == false)
                    {
                        var resizedArrayRLeft = ResizeImage(byteArrayRLeft); 
                        string imgStringRLeft = Convert.ToBase64String(resizedArrayRLeft);
                        <img src="data:image/jpg;base64, @imgStringRLeft" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    else
                    {
                        string imgStringRLeft = Convert.ToBase64String(byteArrayRLeft);
                        <img src="data:image/jpg;base64, @imgStringRLeft" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>

                    }
                    break;
                case 5:
                    byte[] byteArrayPave;

                    if (File.Exists(unmodifiedURLsPave[idx]))
                    {
                        byteArrayPave = ConvertImageToByteArray(unmodifiedURLsPave[idx]);
                    }
                    else
                    {
                        var adjustedPathPave = RemoveRootFromPath(unmodifiedURLsPave[idx]);
                        var fullPathPave = GetImagePath(adjustedPathPave);
                        byteArrayPave = ConvertImageToByteArray(fullPathPave);
                    }
                    if(isHighRes == false)
                    {
                        var resizedArrayPave = ResizeImage(byteArrayPave);
                        string imgStringPave = Convert.ToBase64String(resizedArrayPave);
                        <img src="data:image/jpg;base64, @imgStringPave" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    else
                    {
                        string imgStringPave = Convert.ToBase64String(byteArrayPave);
                        <img src="data:image/jpg;base64, @imgStringPave" style="width: 100%; height: auto;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    break;
                default:
                    byte[] byteArray;

                    if (File.Exists(unmodifiedURLs[idx]))
                    {
                        byteArray = ConvertImageToByteArray(unmodifiedURLs[idx]);
                    }
                    else
                    {
                        var adjustedPath = RemoveRootFromPath(unmodifiedURLs[idx]);
                        var fullPath = GetImagePath(adjustedPath);
                        byteArray = ConvertImageToByteArray(fullPath);
                    }

                    if(isHighRes == false)
                    {
                        var resizedArray = ResizeImage(byteArray);
                        string imgString = Convert.ToBase64String(resizedArray);
                                <img src="data:image/jpg;base64, @imgString" style="width: 100%;" onwheel="@HandleWheelEvent" @ref="imgElement" />
                    }
                    else
                    {
                        string imgString = Convert.ToBase64String(byteArray);
                        <img src="data:image/jpg;base64, @imgString" style="width: 100%;" onwheel="@HandleWheelEvent" @ref="imgElement"/>
                    }
                    break;
                }



                if (double.TryParse(Logmeters[idx], out double logValue))
                {
                    log = logValue * .000621371; //meter to mile conversion
                }
                else
                {
                    Console.WriteLine($"Cannot convert Logmeters[{idx}] value '{Logmeters[idx]}' to a double.");
                }

                if (double.TryParse(Latitudes[idx], out double latValue))
                {
                    latitudeId = latValue;
                }
                else
                {
                    Console.WriteLine($"Cannot convert Latitudes[{idx}] value '{Latitudes[idx]}' to a double.");
                }

                if (double.TryParse(Longitudes[idx], out double lonValue))
                {
                    longitudeId = lonValue;
                }
                else
                {
                    Console.WriteLine($"Cannot convert Longitudes[{idx}] value '{Longitudes[idx]}' to a double.");
                }

            }
        
        </div>

        <div class="google-map-container">
           @* <div id="google-map" style="width: 100%; height: 400px;"></div>*@
            <div id="viewDiv" style="width:900px; height:500px;"></div>
            <div id="infoDiv">
@*                            <input class="esri-component esri-widget--button esri-widget esri-interactive"
                               type="button"
                               id="switch-btn"
                               value="3D" />*@
                        </div>
                        <div id="toolbarDiv" class="esri-component esri-widget">
                            <button id="distance" class="esri-widget--button esri-interactive esri-icon-measure-line" title="Distance Measurement Tool">
                            </button>
                            <button id="area" class="esri-widget--button esri-interactive esri-icon-measure-area" title="Area Measurement Tool">
                            </button>
                            <button id="clear" class="esri-widget--button esri-interactive esri-icon-trash" title="Clear Measurements">
                            </button>
                        </div>
            <div class="dropdowns-container">
            <div>
                Select Basemap: <select id="basemap-select">
                    <option value="streets">Streets</option>
                    <option value="satellite">Satellite</option>
                    <option value="hybrid">Hybrid</option>
                    <option value="terrain">Terrain</option>
                    <option value="topo">Topographic</option>
                    <option value="gray">Gray</option>
                    <option value="dark-gray">Dark Gray</option>
                    <option value="oceans">Oceans</option>
                    <option value="national-geographic">National Geographic</option>
                </select>
            </div>
            <div>
                Select Feature Layer: <select id="feature-layer-select">
                    <option value="">None</option>
                    <option value="https://gis.ardot.gov/hosting/rest/services/SIR_TIS/Road_Inventory_OnSystem/FeatureServer/0">Roadway Inventory</option>
                    <option value="https://gis.ardot.gov/hosting/rest/services/TPP_GISMapping/ARNOLD/FeatureServer/0">ARNOLD Linear</option>
                    <option value="https://gis.ardot.gov/hosting/rest/services/Hosted/ARNOLD_Points/FeatureServer/0">ARNOLD Points</option>
                    <option value="https://gis.ardot.gov/hosting/rest/services/TPP_GISMapping/CORE_BASE_LAYERS/FeatureServer">Core Base Layers</option>
                    <option value="https://gis.arkansas.gov/arcgis/rest/services/FEATURESERVICES/Boundaries/FeatureServer/48">Counties</option>
                    <option value="https://gis.arkansas.gov/arcgis/rest/services/FEATURESERVICES/Boundaries/FeatureServer/41">Municipal Boundries</option>
                    <option value="https://gis.arkansas.gov/arcgis/rest/services/FEATURESERVICES/Planning_Cadastre/FeatureServer/6">Parcel (Ownership) Boundries</option>
                    <option value="https://gis.arkansas.gov/arcgis/rest/services/FEATURESERVICES/Structure/FeatureServer/54">Building Footprints</option>
                    <option value="https://gis.arkansas.gov/arcgis/rest/services/FEATURESERVICES/Location/FeatureServer/14">Address Points</option>
                    <option value="https://fragis.fra.dot.gov/arcgis/rest/services/FRA/MainLine/MapServer/0">Railroads</option>
                        <option value="https://gis.ardot.gov/hosting/rest/services/HeavyBridge/ARDOTBridgeAll/MapServer/0">Bridges</option>
                </select>
            </div>
        </div>
        </div>    
        
    }
    <br>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <img src="/Images/ArDOT_Logo_1.png" style="width: 200px; padding-left: 50px; padding-bottom: 25px; " />
        <ul class="nav flex-column">
            <EditForm id="mySubmitForm" Model="@controller" OnValidSubmit="AsyncLongOperation">
@*                <li class="nav-item px-2">
                    <InputSelect id="countyControl" Value="countyId" ValueChanged="@( (string s) => countyChanged(s))" ValueExpression="@( () => countyId)" class="form-control" @onkeydown="HandleKeyDown">
                        <option value="none">County</option>
                        @foreach (var item in counties)
                        {
                            <option value="@item">@item - @CountiesLookup[Int32.Parse(@item)]</option>
                        }
                    </InputSelect>
                </li>*@

                <li class="nav-item px-2" style="color:white">
                    Route: <InputSelect Style="float: right; margin-left: 5px;" id="routeControl" Value="routeId" ValueChanged="@( (string s) => routeChanged(s))" ValueExpression="@( () => routeId)" class="form-control" @onkeydown="HandleKeyDown">
                        <option value="none">Route</option>
                        @foreach (var item in routes)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Section: <InputSelect Value="sectionId" ValueChanged="@( (string s) => sectionChanged(s))" ValueExpression="@( () => sectionId)" class="form-control" @onkeydown="HandleKeyDown">
                        <option value="none">Section</option>
                        @foreach (var item in sections)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Direction: <InputSelect Value="directionId" ValueChanged="@( (string s) => directionChanged(s))" ValueExpression="@( () => directionId)" class="form-control" @onkeydown="HandleKeyDown">
                        <option value="none">Direction</option>
                        @foreach (var item in directions)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                </li>

                <li class="nav-item px-2" style="color:white">
                    Year: <InputSelect Value="yearId" ValueChanged="@( (string s) => yearChanged(s))" ValueExpression="@( () => yearId)" class="form-control">
                        <option value="none">Year</option>
                        @foreach (var item in years)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Search Logmile: <RadzenTextBox Placeholder="Search Logmile" Name="Logmile" @bind-Value="@searchText" Change=@(args => OnChangeLogmeter(args, "TextBox with placeholder")) />
                </li>
                <li class="nav-item px-2" style="padding-bottom: 20px">
                    <input id="submitButton" type="submit" class="btn btn-primary" value="Submit" disabled="@IsDisabledSubmit" />
                    <input type="reset" onclick="window.location.reload()" class="btn btn-primary" style="position: relative; " value="Clear" />
                </li>
                <li class="nav-item px-2 py-3" style="color:white">
                    Camera Selection: <InputSelect @bind-Value="imgType">
                                          <option value=1 label="Right">Right</option>
                                          <option value=2 label="Left">Left</option>
                                          <option value=3 label="Rear Right">Rear Right</option>
                                          <option value=4 label="Rear Left">Rear Left</option>
                                          <option value=5 label="Pavement">Pavement</option>
                                          <option value=6 label="Center">Center</option>
                                      </InputSelect>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Beginning Logmile: <RadzenTextBox Placeholder="BegLog" Name="BegLog" ReadOnly="true" Value="@Math.Round(begLogmile, 3).ToString()" />
                </li>
                <li class="nav-item px-2" style="color:white">
                    Ending Logmile:  <RadzenTextBox Placeholder="EndLog" Name="EndLog" ReadOnly="true" Value="@Math.Round(endLogmile, 3).ToString()"/>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Current Logmile:  <RadzenTextBox Placeholder="CurLog" Name="CurLog" ReadOnly="true" Value="@Math.Round(log, 3).ToString()"/>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Latitude: <RadzenTextBox Placeholder="Latitude" Name="Lat" ReadOnly="true" Value="@latitudeId.ToString()"/>
                </li>
                <li class="nav-item px-2" style="color:white">
                    Longitude:  <RadzenTextBox Placeholder="Longitude" Name="Long" ReadOnly="true" Value="@longitudeId.ToString()"/>
                </li>
                <li class="nav-item px-2" style="padding-bottom: 20px; padding-top:20px; color:white">
                    Full Resolution Mode:<RadzenSwitch @bind-Value=@isHighRes  Style="float: right; margin-left: 5px;"/>
                </li>

                @if (isMobile == true) { imgQuality = 377; }
                <li class="nav-item px-2" style="padding-bottom: 10px; color:white">
                     Image Quality: <InputSelect @bind-Value="imgQuality" style="float: right; margin-left: 5px;">
                                          <option value=377 label="Low">Low</option>
                                          <option value=600 label="Medium">Medium</option>
                                          <option value=900 label="High">High</option>
                     </InputSelect>
                </li>
                @if(isMobile == true){ imgSpeed = 400; }
                <li class="nav-item px-2" style="padding-bottom: 10px; color:white">
                     Route Speed: <InputSelect @bind-Value="imgSpeed" style="float: right; margin-left: 5px;">
                                          <option value=400 label="Slow">Slow</option>
                                          <option value=220 label="Medium">Medium</option>
                                          <option value=100 label="Fast">Fast</option>
                     </InputSelect>
                </li>
                <li class="nav-item px-2" style="padding-bottom: 10px; color:white">
                    Contrast:
                    <RadzenSlider @bind-Value=@contrast TValue="float" Step=".1" Min="1" Max="3" Change=@(args => OnChange(args, "Slider from 0 to 100")) Class="w-100" />
                </li>
            </EditForm>
        </ul>

    </div>
</div>



@code{

    private bool isFullScreen = false;

    //private async Task ToggleFullScreen()
    //{
    //    if (!isFullScreen)
    //    {
    //        await JSRuntime.InvokeVoidAsync("enterFullScreen");
    //    }
    //    else
    //    {
    //        await JSRuntime.InvokeVoidAsync("exitFullScreen");
    //    }

    //    isFullScreen = !isFullScreen;
    //}

    private ElementReference imgElement;

    [Parameter]
    public string searchText { get; set; }
    private int selectedIndex = 0;

    string[] CountiesLookup = {"","Arkansas","Ashley","Baxter","Benton","Boone","Bradley","Calhoun","Carroll",
                               "Chicot","Clark","Clay","Cleburne","Cleveland","Columbia",
                               "Conway","Craighead","Crawford","Crittenden","Cross","Dallas",
                               "Desha","Drew","Faulkner","Franklin","Fulton","Garland","Grant",
                               "Greene","Hempstead","Hot Spring","Howard","Independence","Izard","Jackson",
                               "Jefferson","Johnson","Lafayette","Lawrence","Lee","Lincoln",
                               "Little River","Logan","Lonoke","Madison","Marion","Miller","Mississippi",
                               "Monroe","Montgomery","Nevada","Newton","Ouachita","Perry",
                               "Phillips","Pike","Poinsett","Polk","Pope","Prairie","Pulaski",
                               "Randolph","Saline","Scott","Searcy","Sebastian","Sevier","Sharp",
                               "St.Francis","Stone","Union","Van Buren","Washington","White","Woodruff","Yell"};

    protected string apiKey = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Keys")["GoogleMapsJavascript"];
    bool isMobile;
    bool isHighRes = true;
    //bool switchMap = false;
    float contrast = 1;
    float imgQuality=600; 
    int imgSpeed=220;
    int imgType=6;
    List<string> resizedImageStrings = new List<string>();
    //PageModel model;

    //map settings ====================================================================================================================================================================
    int zoom = 8;
    bool showArkansasMarker;
    //bool playpause = false;
    string clickedPosition = "";
    bool isTouchScreen;
    List<string> RouteInfo = new List<string>();
    List<string> Logmeters = new List<string>();
    List<string> Latitudes = new List<string>();
    List<string> Longitudes = new List<string>();
    List<string> modifiedURLs = new List<string>();
    List<string> unmodifiedURLs = new List<string>();
    List<string> unmodifiedURLsRight = new List<string>();
    List<string> unmodifiedURLsLeft = new List<string>();
    List<string> unmodifiedURLsRRight = new List<string>();
    List<string> unmodifiedURLsRLeft = new List<string>();
    List<string> unmodifiedURLsPave = new List<string>();

    public int idx;
    IEnumerable<int> negativeValues = new int[] { -100, 100 };
    int value = 0;
    int negativeValue = 0;
    int valueWithStep = 30;
    double begLogmile { get; set; }
    double endLogmile { get; set; }
    double logmile { get; set; }
    double log { get; set; }
    private List<string> counties;
    private List<string> routes;
    private List<string> sections;
    private List<string> directions;
    private List<string> years;

    private int currentCount = 0;
    private Timer time;
    public bool loaded = false;
    public bool isPlay = false;
    public bool isReverse = false;
    public bool isPause = true;
    public bool spinning;
    public bool IsDisabledSubmit = true;
    public bool displayRight = false;
    public bool displayLeft = false;
    public bool displayCenter = true; //display center camera by default

    mmhisContext db = new mmhisContext();

    [Parameter]
    public string routeId { get; set; }
    [Parameter]
    public string directionId { get; set; }
    [Parameter]
    public string sectionId { get; set; }
    [Parameter]
    public string yearId { get; set; }

    public string imgId;
    public double longitudeId = -92.274592; //dogtown bridge
    public double latitudeId = 34.751354;
    public int missingLogmeters;
    public string countyId;

    protected bool IsDisabledRoute = false;
    protected bool IsDisabledDirection = true;
    protected bool IsDisabledSection = true;
    protected bool IsDisabledYear = true;
    protected bool IsDisabledLog = true;
    protected bool IsLandscapeMode = false;

    //Cameras 
    public List<string> Images = new List<string>();             
    public List<string> ImagesLeft = new List<string>();         
    public List<string> ImagesRight = new List<string>();        
    public List<string> ImagesRearLeft = new List<string>();
    public List<string> ImagesRearRight = new List<string>();
    public List<string> ImagesPavement = new List<string>();
    public List<string> notes = new List<string>();

    private EditForm myForm;

    //private DotNetObjectReference<Index> componentReference;
    private DotNetObjectReference<Index> _objRef;


    protected override void OnInitialized()
    {
        routes = controller.GetUniqueRoutes();
        sections = controller.GetUniqueSections();
        years = controller.GetUniqueYears();
        directions = controller.GetUniqueDirections();
        counties = controller.GetUniqueCounties();
        IsDisabledSection = true;
        IsDisabledYear = true;
        IsDisabledDirection = true;
        _objRef = DotNetObjectReference.Create(this);
        JSRuntime.InvokeVoidAsync("setDotNetReference", _objRef);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        int timeInterval = imgSpeed;

        if (firstRender)
        {
            time = new Timer();
            //Set the time interval.
            time.Interval = timeInterval; //around 600 for tablets on cellular
            time.Elapsed += OnTimeInterval;
            time.AutoReset = true;
            // Start the timer.
            //time.Enabled = false;
        }
        base.OnAfterRender(firstRender);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            // Set the flag to false initially

            bool isSetMapLoaded = false;
            await JSRuntime.InvokeVoidAsync("setTitle", "Arkansas Highways");
            await InitializeArcMapAsync();
            isMobile = false;

            if (!string.IsNullOrEmpty(routeId))
            {
                //await Task.Delay(100); // Delay execution by 100 milliseconds
                // Update the IsDisabledSubmit property based on the routeId value
                IsDisabledSubmit = false;
                if (sectionId == "" || sectionId == null)
                {
                    routeChanged(routeId);
                }
                if (directionId == "" || directionId == null)
                {
                    routeChanged(routeId);
                }
                pageModel.Route = routeId;
                pageModel.Direction = directionId;
                pageModel.Section = sectionId;
                logmile = Convert.ToDouble(searchText) * 1609.344;
                pageModel.Logmeter = logmile;

                directionChanged(directionId);
                yearId = years.FirstOrDefault();
                pageModel.Year = yearId;
                await JSRuntime.InvokeVoidAsync("submitForm");

                searchText = "";

            }
            else
            {
                IsDisabledSubmit = true;
            }

            StateHasChanged();

        }


    }

    private async Task InitializeArcMapAsync()
    {
        // Load the Google Maps API script
        await JSRuntime.InvokeVoidAsync("setMap");

        // Start updating the marker's position
        _ = UpdateArcMarkerPositionContinuously(); // Fire and forget
    }

    private async Task UpdateMarkerPositionContinuously()
    {
        while (true)
        {
            await JSRuntime.InvokeVoidAsync("updateMarkerPosition", latitudeId, longitudeId);

            await Task.Delay(500); // wait for .5 second before updating again
        }
    }

    private async Task UpdateArcMarkerPositionContinuously() 
    {
        while(true) 
        {

            await JSRuntime.InvokeVoidAsync("updateArcMarkerPosition", latitudeId, longitudeId);
            await Task.Delay(600);  // for example, to update every .5 seconds
        }
    }


    //=================================================================================================================================================================================
    //==================================================Map Selection Method===========================================================================================================
    //=================================================================================================================================================================================

    const double MILES_TO_KM = 0.000621371192;

    async Task OnMapClick()
    {
        await InvokeAsync(() =>
        {
            ResetStates();
            EnsureInArkansasState();
            RetrieveAndSetRouteInformation();
            ProcessDataModel();
            directionChanged(pageModel.Direction);
            EndOfClickOperations();
            StateHasChanged();  // Trigger UI update.
        });
    }

    void ResetStates()
    {
        spinning = true;
        IsDisabledRoute = true;
        IsDisabledSection = true;
        IsDisabledDirection = true;
        IsDisabledYear = true;
        IsDisabledLog = true;
        isPause = true;
        log = 0;
        RouteInfo.Clear();
        idx = 0;
        zoom = 15;

        ClearImageLists();
        pageModel.Clear();
    }

    void ClearImageLists()
    {
        Images.Clear();
        ImagesRight.Clear();
        ImagesLeft.Clear();
        ImagesRearLeft.Clear();
        ImagesRearRight.Clear();
        ImagesPavement.Clear();
    }

    void EnsureInArkansasState()
    {
        if (latitudeId > 36.5 || latitudeId < 33 || longitudeId < -94.66 || longitudeId > -89.629890)
        {
            latitudeId = 34.751354;
            longitudeId = -92.274592;
        }
    }

    void RetrieveAndSetRouteInformation()
    {
        RouteInfo = controller.GetRouteInformation(latitudeId, longitudeId);
        // Set other class-level fields here using RouteInfo...
        routeId = RouteInfo[0]; //should probably pass in a model here
        sectionId = RouteInfo[1];
        directionId = RouteInfo[2];
        yearId = RouteInfo[3];
        logmile = Convert.ToDouble(RouteInfo[4]);
        latitudeId = Convert.ToDouble(RouteInfo[5]);
        longitudeId = Convert.ToDouble(RouteInfo[6]);
        log = logmile * 0.000621371192;
        countyId = (RouteInfo[10]);

        pageModel.Route = routeId;
        pageModel.Direction = directionId;
        pageModel.Section = sectionId;
        pageModel.Year = yearId;
        pageModel.Logmeter = logmile;
        pageModel.Latitude = latitudeId;
        pageModel.Longitude = longitudeId;
        pageModel.Ld = (long)Convert.ToDouble(RouteInfo[7]); //dains Ld
        pageModel.Lu = (long)Convert.ToDouble(RouteInfo[8]);// dains Lu
        pageModel.County = countyId;
        log = Convert.ToDouble(RouteInfo[4]) * MILES_TO_KM;
    }

    void ProcessDataModel()
    {
        var dataModel = controller.getData(pageModel);
        // Process the dataModel and update the class-level fields as necessary...
        // E.g., the various LINQ queries and their manipulations
        var pointDataList = dataModel.PointData.ToList();

        var dianQuery = from dian in dataModel.Points //get all points in route at 5 meter increments
                        select dian.Ld;

        var fenQueryF = from fen in dataModel.PointData //get all points where there is a front camera
                        join dain in dataModel.Points on fen.Lu equals dain.Ld
                        where fen.FieldName == "f"
                        select fen.Lu;

        var fenQueryFR = from fen in dataModel.PointData //front right
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "fr"
                         select fen.Lu;

        var fenQueryFL = from fen in dataModel.PointData //front left
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "fl"
                         select fen.Lu;

        var fenQueryRR = from fen in dataModel.PointData //rear right
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "rr"
                         select fen.Lu;

        var fenQueryRL = from fen in dataModel.PointData //rear left
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "rl"
                         select fen.Lu;

        var fenQueryP = from fen in dataModel.PointData
                        join dain in dataModel.Points on fen.Lu equals dain.Ld
                        where fen.FieldName == "p"
                        select fen.Lu;

        var resultF = dianQuery.Except(fenQueryF);
        var resultFR = dianQuery.Except(fenQueryFR);
        var resultFL = dianQuery.Except(fenQueryFL);
        var resultRR = dianQuery.Except(fenQueryRR);
        var resultRL = dianQuery.Except(fenQueryRL);
        var resultP = dianQuery.Except(fenQueryP);

        foreach (var item in resultF)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "f",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultFR)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "fr",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultFL)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "fl",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultRR)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "rr",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultRL)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "rl",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultP)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "p",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        dataModel.PointData = pointDataList.OrderBy(x => x.Lu).AsQueryable();

        pointDataList = dataModel.PointData.ToList();
        var pointList = dataModel.Points.ToList();
        var allPoints = from r in pointList
                        select r.Ld;

        var allPointsBefore = from r in pointList
                              where r.Logmeter0 <= pageModel.Logmeter
                              orderby r.Logmeter0 ascending
                              select r.Ld;

        //need to make sure these Lds exsist as pointData.Lus
        //count number of missing values

        var frontImagesLu = from r in pointDataList//grabs all the front facing images for the route
                            join p in pointList on r.Lu equals p.Ld
                            where r.FieldName == "f" //f = front facing camera
                            orderby r.Lu ascending
                            select r.Lu;

        var PointData = frontImagesLu.ToList();
        var Points = allPoints.ToList();

        var setDiff = Points.Except(PointData);
        var setDiffLst = setDiff.ToList();

        var allPointsBeforeLst = allPointsBefore.ToList();

        var IdxB = allPointsBeforeLst.Count();

        var frontImages = from r in pointDataList //grabs all the front facing images for the route
                          join p in pointList on r.Lu equals p.Ld
                          where r.FieldName == "f"
                          orderby r.Lu ascending
                          select r.FieldValue;

        var leftImages = from r in pointDataList
                         join p in pointList on r.Lu equals p.Ld
                         where r.FieldName == "fl"
                         orderby r.Lu ascending
                         select r.FieldValue;

        var rightImages = from r in pointDataList
                          join p in pointList on r.Lu equals p.Ld
                          where r.FieldName == "fr"
                          orderby r.Lu ascending
                          select r.FieldValue;

        var leftRearImages = from r in pointDataList
                             join p in pointList on r.Lu equals p.Ld
                             where r.FieldName == "rl"
                             orderby r.Lu ascending
                             select r.FieldValue;

        var rightRearImages = from r in pointDataList
                              join p in pointList on r.Lu equals p.Ld
                              where r.FieldName == "rr"
                              orderby r.Lu ascending
                              select r.FieldValue;

        var pavementImages = from r in pointDataList
                             join p in pointList on r.Lu equals p.Ld
                             where r.FieldName == "p"
                             orderby r.Lu ascending
                             select r.FieldValue;

        //var logmeters = from r in pointDataList                   //r = mmhisfens(picture location)
        //                join p in pointList on r.Lu equals p.Ld  //p = mmhisdian(log, lat, long)
        //                where r.FieldName == "f"
        //                orderby r.Lu ascending
        //                select p.Logmeter0;

        var logmeters = from r in pointList
                        orderby r.Logmeter0
                        select r.Logmeter0;

        //missingLogmeters = frontImages.Count() - logmeters.Count();

        var latitudes = from r in pointDataList
                        join p in pointList on r.Lu equals p.Ld
                        where r.FieldName == "f"
                        orderby r.Lu ascending
                        select p.Latitude;

        var longitudes = from r in pointDataList
                         join p in pointList on r.Lu equals p.Ld
                         where r.FieldName == "f"
                         orderby r.Lu ascending
                         select p.Longitude;


        var frontImagesStr = frontImages.ToList();
        var rightImagesStr = rightImages.ToList();
        var leftImagesStr = leftImages.ToList();
        var rearLeftImagesStr = leftRearImages.ToList();
        var rearRightImagesStr = rightRearImages.ToList();
        var pavementImagesStr = pavementImages.ToList();

        var logmetersLst = logmeters.ToList();
        var latitudesLst = latitudes.ToList();
        var longitudesLst = longitudes.ToList();
        var logmetersStr = logmetersLst.Select(x => x.ToString());
        var latitudesStr = latitudesLst.Select(x => x.ToString());
        var longitudesStr = longitudesLst.Select(x => x.ToString());

        begLogmile = logmetersLst.First() * 0.000621371;
        endLogmile = logmetersLst.Last() * 0.000621371;

        List<string> preloadImgcpy = frontImagesStr; //unmodified URLs
        List<string> swappedpreloadImgcpy = controller.PutFrontAtIndex(preloadImgcpy, IdxB);

        List<string> swappedPoints = controller.PutFrontAtIndex(frontImagesStr, IdxB);
        List<string> swappedPointsRight = controller.PutFrontAtIndex(rightImagesStr, IdxB);
        List<string> swappedPointsLeft = controller.PutFrontAtIndex(leftImagesStr, IdxB);
        if (rearRightImagesStr.Any())
        {
            List<string> swappedPointsRearRight = controller.PutFrontAtIndex(rearRightImagesStr, IdxB);
            unmodifiedURLsRRight = swappedPointsRearRight;
            ImagesRearRight = swappedPointsRearRight;
        }
        if (rearLeftImagesStr.Any())
        {
            List<string> swappedPointsRearLeft = controller.PutFrontAtIndex(rearLeftImagesStr, IdxB);
            unmodifiedURLsRLeft = swappedPointsRearLeft;
            ImagesRearLeft = swappedPointsRearLeft;
        }
        if (pavementImagesStr.Any())
        {
            List<string> swappedPointsPavement = controller.PutFrontAtIndex(pavementImagesStr, IdxB);
            unmodifiedURLsPave = swappedPointsPavement;
            ImagesPavement = swappedPointsPavement;
        }

        List<string> swappedLogmeters = controller.PutFrontAtIndex(logmetersStr.ToList(), IdxB);
        List<string> swappedLatitudes = controller.PutFrontAtIndex(latitudesStr.ToList(), IdxB);
        List<string> swappedLongitudes = controller.PutFrontAtIndex(longitudesStr.ToList(), IdxB);

        unmodifiedURLs = swappedPoints;
        unmodifiedURLsRight = swappedPointsRight;
        unmodifiedURLsLeft = swappedPointsLeft;

        Images = swappedPoints;
        ImagesRight = swappedPointsRight;
        ImagesLeft = swappedPointsLeft;


        Logmeters = swappedLogmeters;
        Latitudes = swappedLatitudes;
        Longitudes = swappedLongitudes;

    }

    void EndOfClickOperations()
    {
        spinning = false;
        IsDisabledLog = false;
        IsDisabledSubmit = false;

    }

    [JSInvokable]
    public async Task AsyncMapOperation(double lat, double lng) 
    {
        spinning = true;
        Images.Clear();
        StateHasChanged(); //Blazor needs to re-render the component so that the UI is updated

        clickedPosition = $"Map clicked LAT : {lat}, LNG: {lng}";
        latitudeId = lat;
        longitudeId = lng;
        showArkansasMarker = true;
        IsDisabledDirection = false;
        IsDisabledSection = false;
        IsDisabledYear = false;
        //zoom = 15;
        await Task.Run(() => OnMapClick());  //<--here!
        currentCount++;
        spinning = false;
        StateHasChanged(); //re-render again to display the picture
    }



    void OnMarkerClick(GoogleMapClickEventArgs args)
    {
        clickedPosition = $"Map clicked LAT : {args.Position.Lat}, LNG: {args.Position.Lng}";
    }

    async Task AsyncMarkerOperation(GoogleMapClickEventArgs args)    // this is an async task
    {
        spinning = true;
        await Task.Run(() => OnMarkerClick(args));  //<--here!
        currentCount++;
        spinning = false;
    }

    //=================================================================================================================================================================================

    async Task LoadImageAsync(string pathway)
    {
        await JSRuntime.InvokeVoidAsync("loadImage", pathway);


        //return JSRuntime.InvokeVoidAsync("loadImage", pathway).ToString();
    }

    void ClearSelection()
    {
        routeId = null; //could try null
        sectionId = null;
        directionId = null;
        yearId = null;
        IsDisabledDirection = true;
        IsDisabledSection = true;
        IsDisabledYear = true;
        isPlay = false;
        isReverse = false;
        time.Enabled = false;
        showArkansasMarker = false;
        zoom = 8;
        Images.Clear();
        pageModel = new PageModel();
        NavigationManager.NavigateTo("/cleared");
        NavigationManager.NavigateTo("/");

    }

    public void countyChanged(string countyEvent)
    {
        countyId = countyEvent;
        var route = db.MmhisDamus.Select(r => r).Where(r => r.County == countyEvent);
        routes = route.Select(r => r.Route).Distinct().OrderBy(r => r.Length).ThenBy(o => o).ToList();
        routeChanged(routes.FirstOrDefault());
    }

    public void routeChanged(string routeEvent)
    {
        //need to check values of all fields for valid combinations
        IsDisabledSection = false;
        routeId = routeEvent;
        sections.Clear();
        directions.Clear();
        years.Clear();
        var direct = db.MmhisDamus.Select(r => r).Where(r => r.Route == routeEvent);
        sections = direct.Select(r => r.Section).Distinct().OrderBy(r => r.Length).ThenBy(o => o).ToList();
        sectionChanged(sections.FirstOrDefault());
        IsDisabledRoute = true;

    }

    public void sectionChanged(string sectionEvent)
    {
        IsDisabledDirection = false;
        sectionId = sectionEvent;
        var direct = db.MmhisDamus.Select(r => r).Where(r => r.Route == routeId);
        direct = direct.Where(r => r.Section == sectionId);
        directions = direct.Select(r => r.MmhisDirection).Distinct().OrderBy(r => r.Length).ThenBy(o => o).ToList();
        IsDisabledDirection = false;
        if(directionId == null || routeId == null)
        {
            IsDisabledSubmit = true;
        }
        directionChanged(directions.FirstOrDefault());

    }

    public void directionChanged(string directionEvent)
    {
        IsDisabledYear = false;
        directionId = directionEvent;
        years.Clear();
        var year = db.MmhisDamus.Select(r => r).Where(r => r.MmhisDirection == directionEvent);
        year = year.Where(r => r.Route == routeId);
        year = year.Where(r => r.MmhisDirection == directionId);
        year = year.Where(r => r.Section == sectionId);
        years = year.Select(r => r.TheYear).Distinct().OrderByDescending(x => x).ToList();
        IsDisabledSection = true;
        if(sectionId == null || directionId == null || routeId == null)
        {
            IsDisabledSubmit = true;
        }
        yearChanged(years.FirstOrDefault());
    }



    public void yearChanged(string yearEvent)
    {
        yearId = yearEvent;
        IsDisabledLog = false; //allow log search
        if(yearId == null || sectionId == null || directionId == null || routeId == null)
        {
            IsDisabledSubmit = true;
        }
        else{
            IsDisabledSubmit = false;
        }

    }

    //=================================================================================================================================================================================
    //===============================================Dropdown Selection Method=========================================================================================================
    //=================================================================================================================================================================================

    public void findInitialPoint()
    {
        idx = 0;
        IsDisabledDirection = true;
        IsDisabledSection = true;
        IsDisabledYear = true;
        IsDisabledRoute = true;
        pageModel.Route = routeId;
        pageModel.Direction = directionId;
        pageModel.Section = sectionId;
        pageModel.Year = yearId;
        pageModel.Logmeter = logmile;
        pageModel.Latitude = latitudeId;
        pageModel.Longitude = longitudeId;
        pageModel.County = countyId;
        bool isValid = true;
        var dataModel = controller.getData(pageModel); //dataModel.Roadway, dataModel.Points, dataModel.PointData

        if (dataModel == null)
        {
            //invalid input
            isValid = false;
            pageModel.Route = "70";
            pageModel.Direction = "A";
            pageModel.Section = "12";
            pageModel.Year = "2020-07";
            pageModel.Logmeter = 13830;
            pageModel.Latitude = 34.751865;
            pageModel.Longitude = -92.27451;
            pageModel.County = countyId;
            dataModel = controller.getData(pageModel);
        }


        var lat = from r in dataModel.Points
                  select r.Latitude;
        var lng  = from r in dataModel.Points
                  select r.Longitude;
        var log = from r in dataModel.Points
                  orderby r.Logmeter0
                  select r.Logmeter0;

        ///////////////////////<<<<<<<<<<<<<<<<<<<<<<<<<<< SELECT LOGMETERS WHERE NO IMAGES ARE STORED
        //var missingFrames = logmeters where there are no images
        /*SELECT * FROM dataModel.Points
         * WHERE dataModel.Points.Ld not in dataModel.PointData.lu
         * select all unique Points.Ld
         * select unique pointData.lu
         * Find the set differences
         * check each point for the missing frame
        */
        var pointDataList = dataModel.PointData.ToList();

        var dianQuery = from dian in dataModel.Points
                        select dian.Ld;

        var fenQueryF = from fen in dataModel.PointData
                        join dain in dataModel.Points on fen.Lu equals dain.Ld
                        where fen.FieldName == "f"
                        select fen.Lu;

        var fenQueryFR = from fen in dataModel.PointData
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "fr"
                         select fen.Lu;

        var fenQueryFL = from fen in dataModel.PointData
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "fl"
                         select fen.Lu;

        var fenQueryRR = from fen in dataModel.PointData
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "rr"
                         select fen.Lu;

        var fenQueryRL = from fen in dataModel.PointData
                         join dain in dataModel.Points on fen.Lu equals dain.Ld
                         where fen.FieldName == "rl"
                         select fen.Lu;

        var fenQueryP = from fen in dataModel.PointData
                        join dain in dataModel.Points on fen.Lu equals dain.Ld
                        where fen.FieldName == "p"
                        select fen.Lu;

        var resultF = dianQuery.Except(fenQueryF);
        var resultFR = dianQuery.Except(fenQueryFR);
        var resultFL = dianQuery.Except(fenQueryFL);
        var resultRR = dianQuery.Except(fenQueryRR);
        var resultRL = dianQuery.Except(fenQueryRL);
        var resultP = dianQuery.Except(fenQueryP);


        foreach (var item in resultF)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "f",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultFR)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "fr",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultFL)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "fl",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultRR)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "rr",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultRL)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "rl",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        foreach (var item in resultP)
        {
            var newFen = new MmhisFen
                {
                    Lu = item,
                    Lt = 0,
                    FieldCategory = "f",
                    FieldName = "p",
                    FieldValue = "\\\\san2\\MMHIS Data3\\mw42705\\No_Image_Available.jpg"

                };
            pointDataList.Add(newFen);
        }

        dataModel.PointData = pointDataList.OrderBy(x => x.Lu).AsQueryable();


        logmile = log.FirstOrDefault() * 0.000621371;

        latitudeId = Convert.ToDouble(lat.FirstOrDefault());
        longitudeId = Convert.ToDouble(lng.FirstOrDefault());

        var dianLds = from r in dataModel.Points
                      select r.Ld;

        var frontImages = from r in dataModel.PointData
                          where r.FieldName == "f"                          
                          select r.FieldValue;
        var rightImages = from r in dataModel.PointData
                          where r.FieldName == "fr"                          
                          select r.FieldValue;
        var leftImages = from r in dataModel.PointData
                         where r.FieldName == "fl"                          
                         select r.FieldValue;
        var leftRearImages = from r in dataModel.PointData
                             where r.FieldName == "rl"                          
                             select r.FieldValue;
        var rightRearImages = from r in dataModel.PointData
                              where r.FieldName == "rr"                          
                              select r.FieldValue;
        var pavementImages = from r in dataModel.PointData
                             where r.FieldName == "p"                          
                             select r.FieldValue;

        var luValues = (from r in dataModel.PointData
                        where r.FieldName == "f"
                        select r.Lu).Distinct().ToList();

        var latitudes = (from p in dataModel.Points
                         where luValues.Contains(p.Ld)
                         orderby p.Logmeter0 ascending //changed from p.Lu ascending 9/28/23
                         select p.Latitude).ToList();

        var longitudes = (from p in dataModel.Points
                          where luValues.Contains(p.Ld)
                          orderby p.Logmeter0 ascending
                          select p.Longitude).ToList();

        if(dataModel.Notes.ToList() != null)
        {
            notes = dataModel.Notes.ToList();
        }

        if(isValid == false){
            notes.Insert(0, "INVALID INPUT - Default Route Selected. Please 'Clear' and make a new selection.");
        }

        var frontImagesStr = frontImages.ToList();
        var frontRightImagesStr = rightImages.ToList();
        var frontLeftImagesStr = leftImages.ToList();
        var rearLeftImagesStr = leftRearImages.ToList();
        var rearRightImagesStr = rightRearImages.ToList();
        var pavementImagesStr = pavementImages.ToList();

        var logmetersLst = log.ToList();
        var latitudesLst = latitudes.ToList();
        var longitudesLst = longitudes.ToList();
        var logmetersStr = logmetersLst.Select(x => x.ToString());
        var latitudesStr = latitudesLst.Select(x => x.ToString());
        var longitudesStr = longitudesLst.Select(x => x.ToString());

        begLogmile = logmetersLst.First() * 0.000621371;
        endLogmile = logmetersLst.Last() * 0.000621371;

        //for (var i = 0; i < frontImagesStr.Count(); i++)
        //{
        //    frontImagesStr[i] = controller.ModifyURLs(frontImagesStr[i]);
        //}
        unmodifiedURLs = frontImagesStr;
        unmodifiedURLsRight = frontRightImagesStr;
        unmodifiedURLsLeft = frontLeftImagesStr;
        unmodifiedURLsRRight = rearRightImagesStr;
        unmodifiedURLsRLeft = rearLeftImagesStr;
        unmodifiedURLsPave = pavementImagesStr;

        Images = frontImagesStr;
        ImagesRight = unmodifiedURLsRight;
        ImagesLeft = unmodifiedURLsLeft;
        ImagesRearRight = unmodifiedURLsRRight;
        ImagesRearLeft = unmodifiedURLsRLeft;
        ImagesPavement = unmodifiedURLsPave;

        Logmeters = logmetersStr.ToList();
        Latitudes = latitudesStr.ToList();
        Longitudes = longitudesStr.ToList();

        if (pageModel.Logmeter > 0) //if someone searches for a logmeter
        {
            //pointDataList = dataModel.PointData.ToList();
            var pointList = dataModel.Points.ToList();
            var allPoints = from r in pointList
                            select r.Ld;

            var allPointsBefore = from r in pointList 
                                  where r.Logmeter0 <= pageModel.Logmeter
                                  orderby r.Logmeter0 ascending
                                  select r.Ld;

            //need to make sure these Lds exsist as pointData.Lus
            //count number of missing values

            var frontImagesLu = from r in pointDataList//grabs all the front facing images for the route
                                join p in pointList on r.Lu equals p.Ld
                                where r.FieldName == "f" //f = front facing camera
                                orderby r.Lu ascending
                                select r.Lu;
            var logmeters = from r in pointList //grabs all the front facing images for the route
                            orderby r.Logmeter0
                            select r.Logmeter0;

            var PointData = frontImagesLu.ToList();
            var Points = allPoints.ToList();

            var setDiff = Points.Except(PointData);
            var setDiffLst = setDiff.ToList();

            var allPointsBeforeLst = allPointsBefore.ToList();

            var IdxB = allPointsBeforeLst.Count();  

            if(frontImagesStr.Any())
            {
                List<string> swappedPoints = controller.PutFrontAtIndex(frontImagesStr, IdxB);
                Images = swappedPoints;
                unmodifiedURLs = swappedPoints;
            }
            //else if(!frontImagesStr.Any())
            //{
            //    List<string> swappedPoints = controller.PutFrontAtIndex(frontImagesStr, IdxB-1);
            //    Images = swappedPoints;
            //    unmodifiedURLs = swappedPoints;
            //}

            if(frontRightImagesStr.Any())
            {
                List<string> swappedPointsRight = controller.PutFrontAtIndex(frontRightImagesStr, IdxB);
                unmodifiedURLsRight = swappedPointsRight;
            }
            if(frontLeftImagesStr.Any())
            {
                List<string> swappedPointsLeft = controller.PutFrontAtIndex(frontLeftImagesStr, IdxB);
                unmodifiedURLsLeft = swappedPointsLeft;
            }
            if(rearRightImagesStr.Any())
            {
                List<string> swappedPointsRRight = controller.PutFrontAtIndex(rearRightImagesStr, IdxB);
                unmodifiedURLsRRight = swappedPointsRRight;
            }
            if(rearLeftImagesStr.Any())
            {
                List<string> swappedPointsRLeft = controller.PutFrontAtIndex(rearLeftImagesStr, IdxB);
                unmodifiedURLsRLeft = swappedPointsRLeft;
            }
            if(pavementImagesStr.Any())
            {
                List<string> swappedPointsPavement = controller.PutFrontAtIndex(pavementImagesStr, IdxB);
                unmodifiedURLsPave = swappedPointsPavement;
            }

            List<string> swappedLogmeters = controller.PutFrontAtIndex(logmetersStr.ToList(), IdxB);
            List<string> swappedLatitudes = controller.PutFrontAtIndex(latitudesStr.ToList(), IdxB);
            List<string> swappedLongitudes = controller.PutFrontAtIndex(longitudesStr.ToList(), IdxB);

            Logmeters = swappedLogmeters;
            Latitudes = swappedLatitudes;
            Longitudes = swappedLongitudes;
        }

    }
    //=============================================================================================================================================================================
    //=============================================================================================================================================================================
    //=============================================================================================================================================================================

    async Task AsyncLongOperation() 
    {
        spinning = true;
        Images.Clear();
        await Task.Run(() => findInitialPoint());  //<--here!
        showArkansasMarker = true;
        currentCount++;
        spinning = false;
        //await JSRuntime.InvokeVoidAsync("updateMap", latitudeId, longitudeId); //adds the point
        //await JSRuntime.InvokeVoidAsync("closeNav");
    }

    async Task AsyncClearAll()    
    {
        spinning = true;
        await Task.Run(() => ClearSelection());  //<--here!
        currentCount++;
        spinning = false;
        NavigationManager.NavigateTo("/");
        //await JSRuntime.InvokeVoidAsync("window.location.href", "/");
        //await JSRuntime.InvokeVoidAsync("Clear");
    }

    void OnChange(dynamic value, string name)
    {
        isHighRes = false;
        var str = value is IEnumerable ? string.Join(", ", value) : value;
        str = Convert.ToString(str);
        if(str == "1")
        {
            pageModel.ImageSelection = "f";
        }
        else if(str == "2")
        {
            pageModel.ImageSelection = "fl";
        }
        else if(str == "3")
        {
            pageModel.ImageSelection = "fr";
        }
        //pageModel.ImageSelection = str;
    }

    void OnChangeLogmeter(dynamic value, string name)
    {

        var str = value is IEnumerable ? string.Join(", ", value) : value;
        str = Convert.ToString(str);
        logmile = Convert.ToDouble(str) * 1609.344;
        searchText = "";
    }

    void ToggleHighRes()
    {
        isHighRes = !isHighRes;
    }

    void OnSubmitPlay()
    {
        if (Images.Any())
        {
            if(isPause == false)
            {
                isReverse = false;
                isPlay = true;
                time.Enabled = true;
                idx = idx + 1 >= Logmeters.Count() ? 0 : idx + 1;
            }
            else
            {
                OnSubmitStop();
            }
        }
    }

    void OnSubmitReverse()
    {
        if (Images.Any())
        {
            if(isPause == false)
            {
                isPlay = false;
                isReverse = true;
                //isPause = !isPause;
                time.Enabled = true;
                idx = idx - 1 < 0 ? Logmeters.Count() - 1 : idx - 1;
            }
            else
            {
                OnSubmitStop();
            }

        }
    }

    void OnSubmitStop()
    {
        isPlay = false;
        isReverse = false;

        time.Enabled = false;
    }

    private async void OnTimeInterval(object sender, ElapsedEventArgs e)
    {
        //await JSRuntime.InvokeVoidAsync("updateMap", latitudeId, longitudeId); //working but not initializing to first point
        if (isPlay == true)
        {
            //showArkansasMarker = true;
            OnSubmitPlay();
        }
        if (isReverse == true)
        {
            OnSubmitReverse();
        }
        if(isPause == true)
        {
            OnSubmitStop();
        }
        time.Interval = imgSpeed;

        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        // while navigating to other components, Dispose method will be called and clean up the Timer function.
        time?.Dispose();
        //componentReference?.Dispose();
        _objRef?.Dispose();
    }


    public byte[] ResizeImage(byte[] byteImageIn)
    {
        byte[] currentByteImageArray = byteImageIn;
        double scale = 1f;
        //float contrast = 1.5f; // Increase this number for higher contrast

        MemoryStream inputMemoryStream = new MemoryStream(byteImageIn);
        Image fullsizeImage = Image.FromStream(inputMemoryStream);
        int fullsizeImageWidth = fullsizeImage.Width;
        int fullsizeImageHeight = fullsizeImage.Height;

        scale = imgQuality / fullsizeImageWidth; //decrease this number for lower quality image
        fullsizeImageWidth = (int)(fullsizeImageWidth * scale);
        fullsizeImageHeight = (int)(fullsizeImageHeight * scale);

        Bitmap resizedImage = new Bitmap(fullsizeImage.GetThumbnailImage(fullsizeImageWidth, fullsizeImageHeight, null, IntPtr.Zero));

        if(contrast > 1)
        {
            // Apply contrast adjustment
            using (Graphics g = Graphics.FromImage(resizedImage))
            {
                float[][] colorMatrixElements = {
            new float[] {contrast, 0, 0, 0, 0},
            new float[] {0, contrast, 0, 0, 0},
            new float[] {0, 0, contrast, 0, 0},
            new float[] {0, 0, 0, 1, 0},
            new float[] {0, 0, 0, 0, 1}
    };
                ColorMatrix colorMatrix = new ColorMatrix(colorMatrixElements);
                ImageAttributes attributes = new ImageAttributes();
                attributes.SetColorMatrix(colorMatrix, ColorMatrixFlag.Default, ColorAdjustType.Bitmap);
                g.DrawImage(resizedImage, new Rectangle(0, 0, resizedImage.Width, resizedImage.Height), 0, 0, resizedImage.Width, resizedImage.Height, GraphicsUnit.Pixel, attributes);
            }
        }


        MemoryStream outputMemoryStream = new MemoryStream();
        resizedImage.Save(outputMemoryStream, ImageFormat.Jpeg);
        byte[] resizedByteImageArray = outputMemoryStream.ToArray();
        return resizedByteImageArray;
    }

    private async Task HandleWheelEvent(WheelEventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("preventDefault", imgElement);
        if (e.DeltaY > 0 && idx > 0) // Scroll up
        {
            idx--;
        }
        else if (e.DeltaY < 0 && idx < unmodifiedURLs.Count - 1) // Scroll down
        {
            idx++;
        }
        
    }
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowUp" && selectedIndex > 0)
        {
            selectedIndex--;
        }
        else if (e.Key == "ArrowDown" && selectedIndex < counties.Count - 1)
        {
            selectedIndex++;
        }
        else
        {
            return;
        }

    }

    private void ToggleFullScreen()
    {
        // Call the JavaScript function to toggle full-screen for the "video-container" div
        JSRuntime.InvokeVoidAsync("ToggleFullScreen", "video-container");
    }

    public static byte[] ConvertImageToByteArray(string filePath)
    {
        //filePath = GetImagePath(filePath); // Use the helper method

        if (string.IsNullOrEmpty(filePath))
        {
            // Handle the case when the file doesn't exist in either location.
            // This could be returning null, throwing an exception, or any other desired behavior.
            throw new FileNotFoundException("Image not found in the provided paths.", filePath);
        }

        using (var image = Image.FromFile(filePath))
        {
            using (var m = new MemoryStream())
            {
                image.Save(m, image.RawFormat);
                return m.ToArray();
            }
        }
    }

    private string GetImagePath(string relativePath)
    {
        string path1 = "\\\\mmhisdata-01\\" + relativePath;
        if (File.Exists(path1))
        {
            return path1;
        }

        string path2 = "\\\\sirapav-01\\" + relativePath;
        if (File.Exists(path2))
        {
            return path2;
        }

        string path3 = "\\\\san2\\" + relativePath;
        if (File.Exists(path3))
        {
            return path3;
        }

        return string.Empty; // This should be handled in the main code.
    }

    private string RemoveRootFromPath(string path)
    {
        int secondSlashIndex = path.IndexOf('\\', path.IndexOf('\\') + 2);
        if (secondSlashIndex != -1)
        {
            return path.Substring(secondSlashIndex + 1);
        }
        return path; // return original path if the format doesn't match the expected.
    }

}
